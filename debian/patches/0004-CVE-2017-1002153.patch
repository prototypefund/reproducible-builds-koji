From ba7b5a3cbed11ade11c3af5e834c9a6de4f6d7c3 Mon Sep 17 00:00:00 2001
From: Mike McLean <mikem@redhat.com>
Date: Sep 19 2017 21:23:50 +0000
Subject: PR#591: Normalize paths for scms


Merges #591
https://pagure.io/koji/pull-request/591

Fixes #563
https://pagure.io/koji/issue/563

Fixes CVE-2017-1002153

---

Index: koji/koji/daemon.py
===================================================================
--- koji.orig/koji/daemon.py
+++ koji/koji/daemon.py
@@ -257,22 +257,31 @@ class SCM(object):
             netloc = userhost[1]
         elif len(userhost) > 2:
             raise koji.GenericError, 'Invalid username@hostname specified: %s' % netloc
+        if not netloc:
+            raise koji.GenericError, 'Unable to parse SCM URL: %s . Could not find the netloc element.' % self.url
 
-        # ensure that path and query do not end in /
-        if path.endswith('/'):
-            path = path[:-1]
-        if query.endswith('/'):
-            query = query[:-1]
+        # check for empty path before we apply normpath
+        if not path:
+            raise koji.GenericError, 'Unable to parse SCM URL: %s . Could not find the path element.' % self.url
+
+        path = os.path.normpath(path)
+
+        # path and query should not end with /
+        path = path.rstrip('/')
+        query = query.rstrip('/')
+        # normpath might not strip // at start of path
+        if path.startswith('//'):
+            path = '/' + path.strip('/')
+        # path should start with /
+        if not path.startswith('/'):  # pragma: no cover
+            # any such url should have already been caught by is_scm_url
+            raise koji.GenericError, 'Invalid SCM URL. Path should begin with /: %s) '
 
         # check for validity: params should be empty, query may be empty, everything else should be populated
         if params :
             raise koji.GenericError, 'Unable to parse SCM URL: %s . Params element %s should be empty.' % (self.url, params)
         if not scheme :
             raise koji.GenericError, 'Unable to parse SCM URL: %s . Could not find the scheme element.' % self.url
-        if not netloc :
-            raise koji.GenericError, 'Unable to parse SCM URL: %s . Could not find the netloc element.' % self.url
-        if not path :
-            raise koji.GenericError, 'Unable to parse SCM URL: %s . Could not find the path element.' % self.url
         if not fragment :
             raise koji.GenericError, 'Unable to parse SCM URL: %s . Could not find the fragment element.' % self.url
 
